<!DOCTYPE html>
<html>
<head>
    <title>Transbank ChatGPT v1.0 Туршилтын хувилбар</title>
    <link rel="stylesheet" href="/static/css/styles.css">

    <!-- Markdown хөрвүүлэгч -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Highlight.js (code syntax highlight) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <h2>Transbank ChatGPT v1.0 Туршилтын хувилбар</h2>
        <div id="chat-box"></div>
        <div id="input-box">
            <input type="text" id="message" placeholder="Асуултаа энд бичнэ үү..." onkeydown="handleKeyPress(event)">
            <button onclick="sendMessage()" id="sendBtn">Илгээх</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById("chat-box");
        const inputBox = document.getElementById("message");
        const sendBtn = document.getElementById("sendBtn");

        window.onload = () => {
            chatBox.innerHTML = localStorage.getItem('chatHistory') || '';
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        async function sendMessage() {
            let msg = inputBox.value.trim();
            if (!msg) return;

            chatBox.innerHTML += `<div class='user'>${msg}</div>`;
            inputBox.disabled = true;
            sendBtn.disabled = true;

            let botMsgDiv = document.createElement('div');
            botMsgDiv.classList.add('bot');
            botMsgDiv.innerHTML = `
                <img src="/static/img/transbank-logo.png" alt="Transbank" class="bot-logo">
                <div class="bot-content"><i><span class="typing-dots"><span></span><span></span><span></span></span></i></div>
            `;
            chatBox.appendChild(botMsgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            inputBox.value = "";

            try {
                let response = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: msg })
                });

                let data = await response.json();
                let contentDiv = botMsgDiv.querySelector(".bot-content");

                // 429 алдаа ирсэн тохиолдол
                if (response.status === 429 && data.retry_delay) {
                    let seconds = data.retry_delay.seconds || 5;
                    contentDiv.innerHTML = `Quota limit exceeded. Retry in <span id="timer">${seconds}</span> seconds.`;

                    let timer = document.getElementById("timer");
                    let interval = setInterval(() => {
                        seconds--;
                        timer.innerText = seconds;
                        if (seconds <= 0) {
                            clearInterval(interval);
                            contentDiv.innerHTML = "Та одоо дахин оролдож болно.";
                            inputBox.disabled = false;
                            sendBtn.disabled = false;
                            inputBox.focus();
                        }
                    }, 1000);

                } else {
                    // Typing animation Markdown text дээр
                    let replyText = data.reply;
                    contentDiv.innerHTML = "";
                    let i = 0;

                    function typeWriter() {
                        if (i < replyText.length) {
                            contentDiv.innerText += replyText.charAt(i);
                            i++;
                            chatBox.scrollTop = chatBox.scrollHeight;
                            setTimeout(typeWriter, 20);
                        } else {
                            // Markdown → HTML хөрвүүлэлт
                            let finalHTML = marked.parse(contentDiv.innerText);
                            contentDiv.innerHTML = finalHTML;

                            // Code block highlight
                            contentDiv.querySelectorAll("pre code").forEach((block) => {
                                hljs.highlightElement(block);
                            });

                            inputBox.disabled = false;
                            sendBtn.disabled = false;
                            inputBox.focus();

                            // Түүх хадгалах
                            localStorage.setItem('chatHistory', chatBox.innerHTML);
                        }
                    }

                    typeWriter();
                }

            } catch (err) {
                contentDiv.innerHTML = `<span style="color:red;">Алдаа гарлаа: ${err.message}</span>`;
                inputBox.disabled = false;
                sendBtn.disabled = false;
            }

            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === "Enter") sendMessage();
        }
    </script>
</body>
</html>
